<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sign in - XAYTHEON</title>
  <link rel="icon" href="assets/favicon.svg" type="image/svg+xml" />
  <link rel="stylesheet" href="style.css" />
  <script src="boilerplate/boilerplate-loader.js"></script>

  <script defer src="i18n.js"></script>

  <style>
    body {
      font-family: 'Eightgon', 'Researcher', 'OriginTech', sans-serif;
    }

    .auth-wrap {
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 40px 16px;
      background: var(--bg-primary);
    }

    .auth-card {
      width: 100%;
      max-width: 420px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-color);
      border-radius: 14px;
      box-shadow: var(--shadow-md);
      padding: 24px;
    }

    .auth-title {
      font-size: 1.8em;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .auth-sub {
      color: var(--text-secondary);
      margin-bottom: 20px;
    }

    .auth-form {
      display: grid;
      gap: 12px;
    }

    .auth-form label {
      font-weight: 600;
      color: var(--text-primary);
    }

    .auth-form input {
      padding: 12px 14px;
      border: 1px solid var(--border-color-strong);
      border-radius: 8px;
      outline: none;
      font-size: 1em;
      background: var(--bg-primary);
      color: var(--text-primary);
      transition: border-color 0.3s ease;
    }

    .auth-form input:focus {
      border-color: var(--text-primary);
    }

    .auth-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .muted {
      color: var(--text-muted);
      font-size: 0.95em;
    }

    .status {
      min-height: 1.2em;
      margin-top: 10px;
    }

    .center {
      text-align: center;
    }

    .center a {
      color: var(--link-color);
      text-decoration: none;
    }

    .center a:hover {
      color: var(--link-hover);
      text-decoration: underline;
    }

    .theme-toggle-auth {
      position: static;
      top: 20px;
      right: 20px;
      background: transparent;
      border: none;
      width: 36px;
      height: 36px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      padding: 6px;
      border-radius: 8px;
      z-index: 100;
    }

    .theme-toggle-auth:hover {
      background: var(--border-color);
      transform: scale(1.05);
    }

    .theme-toggle-auth:focus {
      outline: 2px solid var(--text-primary);
      outline-offset: 2px;
    }

    .theme-toggle-auth svg {
      width: 20px;
      height: 20px;
      stroke: var(--text-primary);
      fill: none;
      transition: all 0.3s ease;
    }

    .theme-toggle-auth:hover svg {
      transform: rotate(15deg);
    }

    .error-msg {
      color: #dc2626;
      background: #fee2e2;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 0.9em;
      margin-top: 10px;
    }

    .success-msg {
      color: #059669;
      background: #d1fae5;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 0.9em;
      margin-top: 10px;
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      margin-right: 6px;
      vertical-align: middle;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .input-error {
      border-color: #dc2626 !important;
    }

    /* Password Toggle Styles */
    .password-wrapper {
      position: relative;
      width: 100%;
    }

    .password-wrapper input {
      width: 100%;
      padding-right: 2.8rem;
    }

    .toggle-password {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      /* Match input height to center vertically if needed, or just keep auto */
      width: 30px;
    }

    .toggle-password img {
      width: 20px !important;
      height: 20px !important;
      object-fit: contain;
      min-width: 20px;
      /* Prevent squashing */
    }

    /* GitHub Login Styles */
    .btn-github {
      background-color: #24292e;
      color: white;
      width: 100%;
      margin-top: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-weight: 600;
      transition: background-color 0.2s;
    }

    .btn-github:hover {
      background-color: #2f363d;
    }

    .divider {
      display: flex;
      align-items: center;
      text-align: center;
      margin: 20px 0;
      color: var(--text-muted);
    }

    .divider::before,
    .divider::after {
      content: '';
      flex: 1;
      border-bottom: 1px solid var(--border-color);
    }

    .divider span {
      padding: 0 10px;
      font-size: 0.9em;
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      display: none;
      place-items: center;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .modal-overlay.active {
      display: grid;
      opacity: 1;
    }

    .modal-card {
      background: var(--bg-elevated);
      width: 90%;
      max-width: 480px;
      padding: 30px;
      border-radius: 16px;
      border: 1px solid var(--border-color);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }

    .modal-overlay.active .modal-card {
      transform: translateY(0);
    }

    .modal-header {
      margin-bottom: 20px;
      text-align: center;
    }

    .modal-title {
      font-size: 1.5em;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .permission-list {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
    }

    .permission-item {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
      align-items: flex-start;
    }

    .permission-item:last-child {
      margin-bottom: 0;
    }

    .permission-icon {
      color: #10b981;
      margin-top: 2px;
    }

    .permission-text h4 {
      margin: 0 0 4px 0;
      font-size: 1em;
      color: var(--text-primary);
    }

    .permission-text p {
      margin: 0;
      font-size: 0.9em;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    .privacy-note {
      font-size: 0.85em;
      color: var(--text-muted);
      text-align: center;
      margin-bottom: 24px;
      padding: 0 10px;
    }

    .privacy-note a {
      color: var(--link-color);
    }

    .modal-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .btn-cancel {
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: transparent;
      color: var(--text-primary);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-cancel:hover {
      background: var(--bg-primary);
    }

    .btn-confirm {
      padding: 12px;
      border-radius: 8px;
      border: none;
      background: #2ea44f;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-confirm:hover {
      background: #2c974b;
    }
  </style>
</head>

<body>
  <div id="navbar-placeholder"></div>

  <div id="header-placeholder"></div>


  <div class="auth-wrap">
    <div class="auth-card">
      <div class="auth-title">Sign in</div>
      <div class="auth-sub">Sign in using your email and password</div>
      <div id="auth-error" class="auth-error" aria-live="assertive"></div>

      <form id="login-form" class="auth-form" autocomplete="on">
        <label for="login-email">Email</label>
        <input id="login-email" name="email" type="email" placeholder="you@example.com" autocomplete="email" required />


        <label for="login-password">Password</label>
        <div class="password-wrapper">
          <input id="login-password" name="password" type="password" placeholder="••••••••"
            autocomplete="current-password" required />

          <button type="button" class="toggle-password" aria-label="Show password" aria-pressed="false">
            <img id="eye-icon" src="https://img.icons8.com/?size=100&id=59814&format=png&color=000000"
              alt="Show password" />
          </button>
        </div>
        
        <div style="text-align: right; margin-top: -8px;">
  <a href="forgot-password.html" style="color: var(--link-color); text-decoration: none; font-size: 0.9em;">
    Forgot password?
  </a>
</div>

        <button type="submit" class="btn"
          style="width: 100%; margin-top: 24px; background: var(--text-primary); color: var(--bg-primary); font-weight: 600;"
          id="login-submit-btn">Sign in</button>

        <div class="divider">
          <span>OR</span>
        </div>

        <button type="button" class="btn btn-github" id="github-login-btn">
          <svg height="20" width="20" viewBox="0 0 16 16" fill="currentColor">
            <path
              d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
            </path>
          </svg>
          Sign in with GitHub
        </button>

        <div class="center" style="margin-top: 20px;">
          <span class="muted">Don't have an account?</span>
          <a href="register.html" style="font-weight: 600; margin-left: 5px;">Create account</a>
        </div>

        <div class="center muted" style="margin-top: 24px; font-size: 0.85em;">
          Authentication is handled securely by the Xaytheon backend.
        </div>
    </div>
  </div>

  <!-- Github Permission Modal -->
  <div class="modal-overlay" id="github-modal">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-title">
          <svg height="24" width="24" viewBox="0 0 16 16" fill="currentColor">
            <path
              d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
            </path>
          </svg>
          Connect with GitHub
        </h3>
      </div>
      <p style="text-align: center; color: var(--text-secondary); margin-bottom: 20px;">
        Authorize Xaytheon to access your GitHub account. We only request essential permissions:
      </p>

      <div class="permission-list">
        <div class="permission-item">
          <div class="permission-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </div>
          <div class="permission-text">
            <h4>Public Profile (read:user)</h4>
            <p>Access your username, display name, and profile picture to create your Xaytheon account.</p>
          </div>
        </div>
        <div class="permission-item">
          <div class="permission-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
              <polyline points="22,6 12,13 2,6"></polyline>
            </svg>
          </div>
          <div class="permission-text">
            <h4>Email Address (user:email)</h4>
            <p>View your email address for account verification and communication.</p>
          </div>
        </div>
      </div>

      <div class="privacy-note">
        Your data is encrypted. You can <a href="https://github.com/settings/applications" target="_blank"
          rel="noopener noreferrer">revoke access</a> at any time from your GitHub settings.
      </div>

      <div class="modal-actions">
        <button class="btn-cancel" id="cancel-github">Cancel</button>
        <button class="btn-confirm" id="confirm-github">
          Proceed to GitHub
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="5" y1="12" x2="19" y2="12"></line>
            <polyline points="12 5 19 12 12 19"></polyline>
          </svg>
        </button>
      </div>
    </div>
  </div>

  /* Moved to head styles */

  <!-- Inline JS -->
  <script>
    const toggleBtn = document.querySelector(".toggle-password");
    const passwordInput = document.getElementById("login-password");
    const eyeIcon = document.getElementById("eye-icon");

    toggleBtn.addEventListener("click", function () {
      const isHidden = passwordInput.type === "password";

      passwordInput.type = isHidden ? "text" : "password";

      eyeIcon.src = isHidden
        ? "https://img.icons8.com/?size=100&id=7840&format=png&color=000000"
        : "https://img.icons8.com/?size=100&id=59814&format=png&color=000000";

      eyeIcon.alt = isHidden ? "Hide password" : "Show password";
      toggleBtn.setAttribute("aria-pressed", isHidden);
      toggleBtn.setAttribute(
        "aria-label",
        isHidden ? "Hide password" : "Show password"
      );
    });
  </script>


  <script src="auth.js"></script>
  <script>

    // GitHub Login Handling
    const githubBtn = document.getElementById("github-login-btn");
    const githubModal = document.getElementById("github-modal");
    const cancelGithub = document.getElementById("cancel-github");
    const confirmGithub = document.getElementById("confirm-github");

    if (githubBtn) {
      githubBtn.addEventListener("click", () => {
        githubModal.classList.add("active");
        confirmGithub.focus();
      });

      cancelGithub.addEventListener("click", () => {
        githubModal.classList.remove("active");
        githubBtn.focus();
      });

      // Close on outside click
      githubModal.addEventListener("click", (e) => {
        if (e.target === githubModal) {
          githubModal.classList.remove("active");
        }
      });

      confirmGithub.addEventListener("click", () => {
        // Redirect to backend auth initiation
        const API_BASE = "http://127.0.0.1:5000/api/auth";
        window.location.href = `${API_BASE}/github`;
      });
    }

    // Login form handling
    const form = document.getElementById("login-form");
    const emailEl = document.getElementById("login-email");
    const passwordEl = document.getElementById("login-password");
    const statusEl = document.getElementById("auth-error");
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.textContent;

    function validateEmail(email) {
      // More robust email validation
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email) && email.length <= 254 && email.length >= 3;
    }

    function validatePassword(password) {
      return typeof password === 'string' && password.length >= 8 && password.length <= 128;
    }

    function showError(message) {
      statusEl.className = "error-msg";
      statusEl.textContent = message;
      statusEl.setAttribute("role", "alert");
    }

    function showSuccess(message) {
      statusEl.className = "success-msg";
      statusEl.textContent = message;
    }

    function setLoading(isLoading) {
      submitBtn.disabled = isLoading;
      if (isLoading) {
        submitBtn.innerHTML = '<span class="spinner"></span>Signing in...';
      } else {
        submitBtn.textContent = originalBtnText;
      }
    }

    function clearErrors() {
      statusEl.className = "status muted";
      statusEl.textContent = "";
      emailEl.classList.remove("input-error");
      passwordEl.classList.remove("input-error");
    }

    emailEl.addEventListener("input", clearErrors);
    passwordEl.addEventListener("input", clearErrors);

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      clearErrors();

      const email = emailEl.value.trim();
      const password = passwordEl.value;

      if (!email) {
        emailEl.classList.add("input-error");
        showError("Please enter your email");
        emailEl.focus();
        return;
      }

      if (!validateEmail(email)) {
        emailEl.classList.add("input-error");
        showError("Please enter a valid email address");
        emailEl.focus();
        return;
      }

      if (!password) {
        passwordEl.classList.add("input-error");
        showError("Please enter your password");
        passwordEl.focus();
        return;
      }

      if (!validatePassword(password)) {
        passwordEl.classList.add("input-error");
        showError("Password must be between 8 and 128 characters");
        passwordEl.focus();
        return;
      }

      setLoading(true);

      try {
        await window.XAYTHEON_AUTH.login(email, password);
        showSuccess("Login successful!");
        setTimeout(() => {
          window.location.href = "index.html";
        }, 100);
      }
      catch (err) {
        setLoading(false);

        const message = getAuthErrorMessage(err);
        showError(message);

        // Highlight fields for credential-related errors
        if (err.code === "INVALID_CREDENTIALS") {
          emailEl.classList.add("input-error");
          passwordEl.classList.add("input-error");
        }
      }

    });
  </script>
  <script src="theme.js"></script>
<div id="footer-placeholder"></div>

</html>